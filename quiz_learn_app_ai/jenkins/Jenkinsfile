pipeline {
    agent any
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Setup Flutter') {
            steps {
                script {
                    def flutterHome = "${WORKSPACE}/flutter"
                    def androidSdkRoot = "${WORKSPACE}/android-sdk"
                    
                    sh '''
                        if [ ! -d "${flutterHome}" ]; then
                            git clone https://github.com/flutter/flutter.git -b stable "${flutterHome}"
                        fi
                        ${flutterHome}/bin/flutter precache
                        ${flutterHome}/bin/flutter doctor
                    '''
                    
                    // Set Flutter and Android SDK paths for subsequent stages
                    env.PATH = "${flutterHome}/bin:${androidSdkRoot}/tools/bin:${env.PATH}"
                    env.ANDROID_HOME = androidSdkRoot
                }
            }
        }
        
        stage('Install Android SDK') {
            steps {
                script {
                    def androidSdkRoot = "${WORKSPACE}/android-sdk"
                    
                    sh '''
                        mkdir -p ${androidSdkRoot}
                        wget -O android_sdk.zip https://dl.google.com/android/repository/commandlinetools-linux-6858069_latest.zip
                        unzip -q android_sdk.zip -d ${androidSdkRoot}
                        yes | ${androidSdkRoot}/tools/bin/sdkmanager --sdk_root=${androidSdkRoot} "platform-tools" "build-tools;30.0.3" "platforms;android-30"
                    '''
                }
            }
        }
        
        stage('Build APK') {
            steps {
                dir('quiz_learn_app_ai') { // Replace with your actual project directory
                    script {
                        def flutterHome = "${WORKSPACE}/flutter"
                        
                        sh '''
                            ${flutterHome}/bin/flutter pub get
                            ${flutterHome}/bin/flutter build apk
                        '''
                    }
                }
            }
        }
    }
}
