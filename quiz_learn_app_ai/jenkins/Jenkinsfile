pipeline {
    agent any

    environment {
        ANDROID_HOME = "${WORKSPACE}/android-sdk"
        PATH = "${ANDROID_HOME}/cmdline-tools/latest/bin:${ANDROID_HOME}/platform-tools:${ANDROID_HOME}/emulator:${ANDROID_HOME}/tools:${ANDROID_HOME}/tools/bin:${WORKSPACE}/flutter/bin:${env.PATH}"
    }

    stages {
        stage('Checkout') {
            steps {
                git credentialsId: '58d656b9-abba-4fb4-8eea-a1cc309cf805', url: 'https://github.com/BS-PMC-2024/BS-PMC-2024-Team18.git'
            }
        }
        
        stage('Setup Flutter') {
            steps {
                sh '''
                    if [ -d flutter ]; then
                        rm -rf flutter
                    fi
                    git clone https://github.com/flutter/flutter.git -b stable
                    export PATH="${WORKSPACE}/flutter/bin:${PATH}"
                    flutter precache
                    flutter doctor
                '''
            }
        }

        stage('Install Dependencies') {
            steps {
                sh 'flutter pub get'
            }
        }

        stage('Build') {
            steps {
                sh 'flutter build apk --release'
            }
        }

        stage('Archive APK') {
            steps {
                archiveArtifacts artifacts: 'build/app/outputs/flutter-apk/app-release.apk', allowEmptyArchive: true
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}
