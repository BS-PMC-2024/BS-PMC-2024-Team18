pipeline {
    agent any
    stages {
        stage('Checkout') {
            steps {
                git 'https://github.com/BS-PMC-2024/BS-PMC-2024-Team18.git'
            }
        }
        stage('Setup Flutter') {
            steps {
                sh '''
                    # Remove existing Flutter directory if present
                    rm -rf flutter
                    
                    # Clone the Flutter SDK
                    git clone https://github.com/flutter/flutter.git -b stable

                    # Set Flutter SDK path
                    export PATH=\$PATH:\$PWD/flutter/bin

                    # Precache Flutter dependencies
                    flutter precache

                    # Install Android SDK command-line tools
                    mkdir -p android-sdk/cmdline-tools
                    curl -o commandlinetools-linux.zip https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
                    unzip -q commandlinetools-linux.zip -d android-sdk/cmdline-tools
                    mv android-sdk/cmdline-tools/cmdline-tools android-sdk/cmdline-tools/tools
                    rm commandlinetools-linux.zip

                    # Set Android SDK path
                    export ANDROID_HOME=\$PWD/android-sdk
                    export PATH=\$PATH:\$ANDROID_HOME/cmdline-tools/tools/bin

                    # Accept licenses
                    yes | sdkmanager --licenses

                    # Install essential SDK packages
                    sdkmanager "platform-tools" "platforms;android-30" "build-tools;30.0.3"
                '''
            }
        }
        stage('Build') {
            steps {
                dir('quiz_learn_app_ai') {
                    sh '''
                        # Set environment variables
                        export PATH=\$PATH:\$PWD/../flutter/bin
                        export ANDROID_HOME=\$PWD/../android-sdk

                        # Get Flutter dependencies
                        flutter pub get

                        # Build the APK
                        flutter build apk
                    '''
                }
            }
        }
    }
}
